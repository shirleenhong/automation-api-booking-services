*** Settings ***
Library           OperatingSystem
Resource    ../../resources/api-imports.txt
Resource    ../../resources/api-utilities.txt
Resource    ../../resources/api-variables.txt
*** Keywords ***
Create New Product List
    [Arguments]    ${product_number}
    ${all_product_list_length}    Get Length    ${all_product_list}
    ${index}    Set Variable    ${all_product_list_length}    
    @{product_list}    Create List
    Set Test Variable    ${${product_number}_list}    ${product_list}
    Set Test variable    ${product_list_${index}}    ${${product_number}_list}
    Append To List    ${all_product_list}    ${product_number}
    Set Test Variable    ${index}    
    Set Test Variable    ${all_product_list}

Create Test Variables For Products And Vendors
    [Arguments]    ${country}
    @{all_product_list}    Create List
    @{product_remarks_list}    Create List
    Set Test Variable    ${all_product_list}
    Set Test Variable    ${product_remarks_list}
    ${data_list_1}    Split String    ${${country}_data_list_1}    |
    : FOR    ${data}    IN    @{data_list_1}
    \    ${character}    Run Keyword If    "${country}"=="in"    Set Variable    _    ELSE    Set Variable    ,        
    \    ${data_item}    Split String    ${data}    ${character}
    \    ${data_type}    Get Substring    ${data_item[0]}    0    3
    \    ${item_number}    Get Substring    ${data_item[0]}    3
    \    ${data_type}    Set Variable If    "${data_type.upper()}"=="PRO"    product    vendor
    \    Set Test Variable    ${${data_type}_code_${item_number}}    ${data_item[1]}
    \    Run Keyword If    "${data_type}"=="product" and "${country}"!="in"    Set Test Variable    ${${data_type}_type_${item_number}}    ${data_item[2]}
    ${data_list_2}    Split String    ${${country}_data_list_2}    |
    : FOR    ${data}    IN    @{data_list_2}
    \    ${data_item}    Split String    ${data}    ,
    \    ${product_number}    Get Substring    ${data_item[0]}    3
    \    ${vendor_number}    Get Substring    ${data_item[1]}    3
    \    ${is_list_created}    Run Keyword And Return Status    Variable Should Exist    ${${product_number}_list}
    \    Run Keyword If    "${is_list_created}"=="False"    Create New Product List    ${product_number}    
    \    Append To List    ${product_list_${index}}    ${vendor_number}
    : FOR    ${item}    IN RANGE    0    ${index}+1
    \    Set Test Variable    ${product_list_${item}}
    \    Log    ${product_list_${item}}
    Run Keyword If    "${country}"!="in"    Create Test Data For Vendor Raise Type    ${country}
    Set Test Variable    ${country}    ${country.upper()}
    Set Test Variable    ${all_product_list}

Create Test Data For Vendor Raise Type
    [Arguments]    ${country}
    ${data_list}    Split String    ${${country}_raise_type_list}    |
    : FOR    ${data}    IN    @{data_list}
    \    ${data_item}    Split String    ${data}    ,
    \    ${item_number}    Get Substring    ${data_item[0]}    3
    \    Set Test Variable    ${raise_type_${item_number}}    ${data_item[1]}
    
Send Product Get Request
    [Arguments]    ${token}=${default_token}    ${country}=${country}
    Create Session    product    ${${env}_base_url}    verify=True
    ${headers}    Run Keyword If    "${token}" != "None"    Create Dictionary    Content-Type=application/json    Authorization=Bearer ${token}
    ...    ELSE    Create Dictionary    Content-Type=application/json
    ${response}    Get Request    product    /apac-services-rest/api/products/${country}    headers=${headers}
    Set Test Variable    ${response}
    Log    ${response.headers}
    Log    ${response.content}
    Set Test Variable    ${api_flag}    products

Verify Products And Vendors Are Not Retrieved
    Verify String Does Not Contain Substring    ${response.content}    "vendors"
    Verify String Does Not Contain Substring    ${response.content}    "countryCode"
    Verify String Does Not Contain Substring    ${response.content}    "productCode"
    Verify String Does Not Contain Substring    ${response.content}    "description"
    Verify String Does Not Contain Substring    ${response.content}    "enableCCFOP"
    Verify String Does Not Contain Substring    ${response.content}    "gst"
    Verify String Does Not Contain Substring    ${response.content}    "mi"
    Verify String Does Not Contain Substring    ${response.content}    "sortKey"
    Verify String Does Not Contain Substring    ${response.content}    "tktNo"
    Verify String Does Not Contain Substring    ${response.content}    "tktPrefix"
    Verify String Does Not Contain Substring    ${response.content}    "type"

Verify Products And Vendors Are Retrieved Correctly
    Comment    Create File    ${EXECDIR}/file_with_products_vendors.txt    ${response.content}
    ${all_product_list_length}    Get Length    ${all_product_list}
    : FOR    ${index}    IN RANGE    ${all_product_list_length}
    \    ${item_product_code}    Get Json Value As String    ${response.content}    $.[${index}].productCode
    \    Verify Json Value Is Correct    $[${index}].description    ${product_code_${item_product_code}}
    \    Verify Vendors Are Retrieved Correctly    ${index}    ${product_list_${index}}
    ${index}    Evaluate    ${index}+1
    Verify Json Element Does Not Exist    $[${index}].description

Verify Vendors Are Retrieved Correctly
    [Arguments]    ${index}    ${item_vendor_list}
    ${item_vendor_list_length}    Get Length    ${item_vendor_list}
    ${vendor_index}    Set Variable    0
    :FOR    ${vendor_index}    IN RANGE    ${item_vendor_list_length}
    \    ${list_item}    Get From List    ${item_vendor_list}    ${vendor_index}
    \    Verify Json Value Is Correct    $[${index}].vendors.[${vendor_index}].code    ${list_item}
    \    Verify Json Value Is Correct    $[${index}].vendors.[${vendor_index}].name    ${vendor_code_${list_item}}   
    \    Run Keyword If    "${country}"!="IN"    Verify Vendor Raise Type Is Retrieved Correctly    ${index}    ${list_item}    ${vendor_index}
    \    ${vendor_index}    Evaluate    ${vendor_index}+1
    Verify Json Element Does Not Exist    $[${index}].vendors.[${vendor_index}].vendorName

Verify Vendor Raise Type Is Retrieved Correctly
    [Arguments]    ${index}    ${list_item}    ${vendor_index}
    Run Keyword If    "${raise_type_${list_item}}"!="NULL"    Verify Json Value Is Correct    $[${index}].vendors.[${vendor_index}].raiseType    ${raise_type_${list_item}}    ELSE IF    "${country}"!="IN" and "${raise_type_${list_item}}"=="NULL"    Verify Json Element Does Not Exist    $[${index}].vendors.[${vendor_index}].raiseType