*** Settings ***
Resource          ../../resources/api-imports.txt

*** Keywords ***
Calculate Commission Amount
    [Arguments]    ${decimal_place}    ${base_fare_value}    ${commission_percentage_value}=${commission_percentage_value}
    ${calculated_value}    Evaluate    round((${base_fare_value}*(${commission_percentage_value}/100)), ${decimal_place})
    ${calculated_value}    Convert To String    ${calculated_value}
    ${calculated_value}    Fix Decimal Places    ${calculated_value}
    Set Test Variable    ${commission_amount}    ${calculated_value}

Calculate FOP Amount
    [Arguments]    ${decimal_place}    ${base_fare}    ${taxes}= ${taxes_value}    ${markup_amount}=${markup_amount}    ${commission}=${commission_amount}
    ${calculated_value}    Evaluate    round(((${base_fare}+${taxes}+${markup_amount})-${commission}), ${decimal_place})
    ${calculated_value}    Convert To String    ${calculated_value}
    ${calculated_value}    Fix Decimal Places    ${calculated_value}
    Set Test Variable    ${fop_amount}    ${calculated_value}

Calculate Fare Incuding Air Taxes
    [Arguments]    ${decimal_place}    ${base_fare_value}    ${taxes_value}=${taxes_value}    ${ob_fee_value}=${ob_fee_value}    ${markup_amount_value}=${markup_amount_value}    ${commission}=${commission_amount}
    ${calculated_value}    Evaluate    round(((${base_fare_value}+${taxes_value}+${ob_fee_value}+${markup_amount})-${commission}), ${decimal_place})
    ${calculated_value}    Convert To String    ${calculated_value}
    ${calculated_value}    Fix Decimal Places    ${calculated_value}
    Set Test Variable    ${fare_including_air_taxes}    ${calculated_value}

Calculate Markup Amount
    [Arguments]    ${decimal_place}    ${base_fare_value}    ${markup_percentage_value}=${markup_percentage_value}
    ${calculated_value}    Evaluate    round((${base_fare_value}*(${markup_percentage_value}/100)), ${decimal_place})
    ${calculated_value}    Convert To String    ${calculated_value}
    ${calculated_value}    Fix Decimal Places    ${calculated_value}
    Set Test Variable    ${markup_amount}    ${calculated_value}

Calculate Merchant Fee Amount
    [Arguments]    ${decimal_place}    ${base_fare_value}=${base_fare_value}    ${taxes_value}=${taxes_value}    ${merchant_percentage_value}=${merchant_percentage_value}    ${markup_amount_value}=${markup_amount}    ${commission}=${commission_amount}
    ${charged_fare_value}    Evaluate    ${base_fare_value}+${taxes_value}
    ${calculated_value}    Evaluate    ((${charged_fare_value}+${markup_amount_value})-${commission})*(${merchant_percentage_value}/100)
    ${calculated_value}    Evaluate    round(${calculated_value},${decimal_place})
    ${calculated_value}    Convert To String    ${calculated_value}
    ${calculated_value}    Fix Decimal Places    ${calculated_value}
    Set Test Variable    ${merchant_amount}    ${calculated_value}

Calculate Total Amount
    [Arguments]    ${decimal_place}    ${fare_including_air_taxes}=${fare_including_air_taxes}    ${transaction_amount}=${transaction_amount}    ${merchant_amount}=${merchant_amount}    ${fuel_surcharge}=${fuel_surcharge_value}
    ${calculated_total_amount_value}    Evaluate    ${fare_including_air_taxes}+${transaction_amount}+${merchant_amount}+${fuel_surcharge}
    ${calculated_total_amount_value}    Evaluate    round(${calculated_total_amount_value},${decimal_place})
    ${calculated_total_amount_value}    Convert To String    ${calculated_total_amount_value}
    ${calculated_total_amount_value}    Fix Decimal Places    ${calculated_total_amount_value}
    Set Test Variable    ${calculated_total_amount_value}

Calculate Transaction Fee Amount
    [Arguments]    ${decimal_place}    ${base_fare_value}    ${transaction_percentage_value}=${transaction_percentage_value}
    ${calculated_value}    Evaluate    round((${base_fare_value}*(${transaction_percentage_value}/100)), ${decimal_place})
    ${calculated_value}    Convert To String    ${calculated_value}
    ${calculated_value}    Fix Decimal Places    ${calculated_value}
    Set Test Variable    ${transaction_amount}    ${calculated_value}

Generate Test Variables For Calculate Fees
    [Arguments]    ${fees_list}    ${country}=SG
    Parse Service Fees List    ${fees_list}    ${country}
    ${fare}    Set Variable If    "${base_fare_value}" == "null"    ${nett_fare_value}    ${base_fare_value}
    ${decimal_place}    Set Variable If    "${country.upper()}" == "SG"    2    0
    Run Keyword If    "${fuel_surcharge_value}" == "null"    Set Test Variable    ${fuel_surcharge_value}    0
    Run Keyword If    "${commission_amount_value}" == "null" and "${commission_percentage_value}" != "null"    Calculate Commission Amount    ${decimal_place}    ${fare}    ${commission_percentage_value}
    ...    ELSE IF    "${commission_amount_value}" == "null" and "${commission_percentage_value}" == "null"    Set Test Variable    ${commission_amount}    0
    ...    ELSE    Set Test Variable    ${commission_amount}    ${commission_amount_value}
    Run Keyword If    "${markup_amount_value}" == "null" and "${markup_percentage_value}" != "null"    Calculate Markup Amount    ${decimal_place}    ${fare}    ${markup_percentage_value}
    ...    ELSE IF    "${markup_amount_value}" == "null" and "${markup_percentage_value}" == "null"    Set Test Variable    ${markup_amount}    0
    ...    ELSE    Set Test Variable    ${markup_amount}    ${markup_amount_value}
    Run Keyword If    "${merchant_amount_value}" == "null" and "${merchant_percentage_value}" != "null"    Calculate Merchant Fee Amount    ${decimal_place}    ${fare}    ${taxes_value}    ${merchant_percentage_value}
    ...    ELSE IF    "${merchant_amount_value}" == "null" and "${merchant_percentage_value}" == "null"    Set Test Variable    ${merchant_amount}    0
    ...    ELSE    Set Test Variable    ${merchant_amount}    ${merchant_amount_value}
    Run Keyword If    "${transaction_amount_value}" == "null" and "${transaction_percentage_value}" != "null"    Calculate Transaction Fee Amount    ${decimal_place}    ${fare}    ${transaction_percentage_value}
    ...    ELSE IF    "${transaction_amount_value}" == "null" and "${transaction_percentage_value}" == "null"    Set Test Variable    ${transaction_amount}    0
    ...    ELSE    Set Test Variable    ${transaction_amount}    ${transaction_amount_value}
    Calculate FOP Amount    ${decimal_place}    ${fare}
    Calculate Fare Incuding Air Taxes    ${decimal_place}    ${fare}
    Calculate Total Amount    ${decimal_place}
    Run Keyword If    "${country.upper()}" != "SG"    Remove Decimal Places

Parse Fees List
    [Arguments]    ${fees_list}
    ${fees_list}    Split String    ${fees_list}    |
    : FOR    ${item}    IN    @{fees_list}
    \    ${details_list}    Split String    ${item}    ,
    \    Set Test Variable    ${${details_list[0]}}    ${details_list[1]}

Parse Service Fees List
    [Arguments]    ${fees_list}    ${country}
    [Documentation]    sample data: fees_list=base_fare;1|taxes;2|ob_fee;3|merchant_amount;null|merchant_percentage;6|transaction_amount;7|transaction_percentage;null|markup_amount;9|markup_percentage;null|commission_amount;11|commission_percentage;12|fuel_surcharge;13|nett_fare;14
    ...
    ...    country=sg
    ${fees_list}    Split String    ${fees_list}    |
    : FOR    ${fees}    IN    @{fees_list}
    \    ${fees_item}    Split String    ${fees}    ,
    \    Set Test Variable    ${${fees_item[0]}_value}    ${fees_item[1]}
    Set Test Variable    ${fees_list}
    Set Test Variable    ${country}

Remove Decimal Places
    Comment    ${commission_amount}    Convert To String    ${commission_amount}
    Comment    ${fop_amount}    Convert To String    ${fop_amount}
    Comment    ${fare_including_air_taxes}    Convert To String    ${fare_including_air_taxes}
    Comment    ${markup_amount}    Convert To String    ${markup_amount}
    Comment    ${merchant_amount}    Convert To String    ${merchant_amount}
    Comment    ${transaction_amount}    Convert To String    ${transaction_amount}
    Comment    ${calculated_total_amount_value}    Convert To String    ${calculated_total_amount_value}
    ${commission_amount}    Remove String    ${commission_amount}    .00
    ${fop_amount}    Remove String    ${fop_amount}    .00
    ${fare_including_air_taxes}    Remove String    ${fare_including_air_taxes}    .00
    ${markup_amount}    Remove String    ${markup_amount}    .00
    ${merchant_amount}    Remove String    ${merchant_amount}    .00
    ${transaction_amount}    Remove String    ${transaction_amount}    .00
    ${calculated_total_amount_value}    Remove String    ${calculated_total_amount_value}    .00
    Set Test Variable    ${commission_amount}
    Set Test Variable    ${fop_amount}
    Set Test Variable    ${fare_including_air_taxes}
    Set Test Variable    ${markup_amount}
    Set Test Variable    ${merchant_amount}
    Set Test Variable    ${transaction_amount}
    Set Test Variable    ${calculated_total_amount_value}

Send Service Fees Post Request
    [Arguments]    ${token}=${default_token}
    Create Session    fees    ${${env}_base_url}    verify=True
    ${headers}    Run Keyword If    "${token}" != "None"    Create Dictionary    Content-Type=application/json    Authorization=Bearer ${token}
    ...    ELSE    Create Dictionary    Content-Type=application/json
    @{calculate_request_list}    Create List
    Run Keyword If    "${country}"!="null"    Append To List    ${calculate_request_list}    "country":"${country}"
    Run Keyword If    "${base_fare_value}"!="null"    Append To List    ${calculate_request_list}    "baseFare":${base_fare_value}
    Run Keyword If    "${taxes_value}"!="null"    Append To List    ${calculate_request_list}    "totalTaxes":${taxes_value}
    Run Keyword If    "${ob_fee_value}"!="null"    Append To List    ${calculate_request_list}    "obFee":${ob_fee_value}
    Run Keyword If    "${merchant_amount_value}"!="null"    Append To List    ${calculate_request_list}    "merchantFeeAmount":${merchant_amount_value}
    Run Keyword If    "${merchant_percentage_value}"!="null"    Append To List    ${calculate_request_list}    "merchantFeePercentage":${merchant_percentage_value}
    Run Keyword If    "${transaction_amount_value}"!="null"    Append To List    ${calculate_request_list}    "transactionFeeAmount":${transaction_amount_value}
    Run Keyword If    "${transaction_percentage_value}"!="null"    Append To List    ${calculate_request_list}    "transactionFeePercentage":${transaction_percentage_value}
    Run Keyword If    "${markup_amount_value}"!="null"    Append To List    ${calculate_request_list}    "markupAmount":${markup_amount_value}
    Run Keyword If    "${markup_percentage_value}"!="null"    Append To List    ${calculate_request_list}    "markupPercentage":${markup_percentage_value}
    Run Keyword If    "${commission_amount_value}"!="null"    Append To List    ${calculate_request_list}    "commissionRebateAmount":${commission_amount_value}
    Run Keyword If    "${commission_percentage_value}"!="null"    Append To List    ${calculate_request_list}    "commissionRebatePercentage":${commission_percentage_value}
    Run Keyword If    "${fuel_surcharge_value}"!="null"    Append To List    ${calculate_request_list}    "fuelSurcharge":${fuel_surcharge_value}
    Run Keyword If    "${nett_fare_value}"!="null"    Append To List    ${calculate_request_list}    "nettFare":${nett_fare_value}
    ${list_count}    Get Length    ${calculate_request_list}
    : FOR    ${i}    IN RANGE    0    ${list_count}
    \    ${fees_list}    Set Variable If    ${i}==0    ${EMPTY}    ${fees_list},
    \    ${fees_list}    Set Variable    ${fees_list}${calculate_request_list[${i}]}
    ${data}    Set Variable    {${fees_list}}
    Log    ${data}
    ${response}    Post Request    fees    /bpg-cbt-apac-services-rest/api/servicefee    data=${data}    headers=${headers}
    Set Test Variable    ${response}
    Log    ${response.headers}
    Log    ${response.content}
    Set Test Variable    ${api_flag}    fees

Verify Calculated Fees Are Not Returned
    Verify String Does Not Contain Substring    ${response.content}    /fopAmount
    Verify String Does Not Contain Substring    ${response.content}    /merchantFeeAmount
    Verify String Does Not Contain Substring    ${response.content}    /transactionFeeAmount
    Verify String Does Not Contain Substring    ${response.content}    /markupAmount
    Verify String Does Not Contain Substring    ${response.content}    /commissionRebateAmount
    Verify String Does Not Contain Substring    ${response.content}    /airFareWithTaxAmount
    Verify String Does Not Contain Substring    ${response.content}    /totalAmount

Verify Calculated Fees Are Returned Correctly
    Run Keyword If    "${fop_amount}" != "0"    Verify Json Value Is Correct    /fopAmount    ${fop_amount}    int
    ...    ELSE    Verify Json Element Does Not Exist    /fopAmount
    Run Keyword If    "${merchant_amount}" != "0"    Verify Json Value Is Correct    /merchantFeeAmount    ${merchant_amount}    int
    ...    ELSE    Verify Json Element Does Not Exist    /merchantFeeAmount
    Run Keyword If    "${transaction_amount}" != "0"    Verify Json Value Is Correct    /transactionFeeAmount    ${transaction_amount}    int
    ...    ELSE    Verify Json Element Does Not Exist    /transactionFeeAmount
    Run Keyword If    "${markup_amount}" != "0"    Verify Json Value Is Correct    /markupAmount    ${markup_amount}    int
    ...    ELSE    Verify Json Element Does Not Exist    /markupAmount
    Run Keyword If    "${commission_amount}" != "0"    Verify Json Value Is Correct    /commissionRebateAmount    ${commission_amount}    int
    ...    ELSE    Verify Json Element Does Not Exist    /commissionRebateAmount
    Run Keyword If    "${fare_including_air_taxes}" != "0"    Verify Json Value Is Correct    /airFareWithTaxAmount    ${fare_including_air_taxes}    int
    ...    ELSE    Verify Json Element Does Not Exist    /airFareWithTaxAmount
    Run Keyword If    "${calculated_total_amount_value}" != "0"    Verify Json Value Is Correct    /totalAmount    ${calculated_total_amount_value}    int
    ...    ELSE    Verify Json Element Does Not Exist    /totalAmount
