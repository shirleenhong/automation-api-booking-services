*** Settings ***
Resource    ../../resources/api-imports.txt
Resource    ../../resources/api-utilities.txt
Resource    ../../resources/api-variables.txt
*** Keywords ***
Calculate Air Fees-HK Commission
    Run Keyword If    "${client_type_value.upper()}" == "TP"    Set Test Variable    ${commission_amount}    0
    ...    ELSE    Calculate Air Fees-HK Commission With Client Type

Calculate Air Fees-HK Commission With Client Type
    ${nett_fare_commision_condition}    Evaluate    (${nett_fare_value}/(1-${commission_percentage_value}*0.01))-${nett_fare_value}
    ${commission_formula}    Set Variable If    ${nett_fare_commision_condition}>0 and "${client_type_value.upper()}" == "DU"    ((${nett_fare_value}/(1-${commission_percentage_value}*0.01)) -${nett_fare_value})+10    ((${nett_fare_value}/(1-${commission_percentage_value}*0.01)) -${nett_fare_value})
    ${calculated_value}    Evaluate    ${commission_formula}
    ${calculated_value}    Evaluate    round(${calculated_value},${decimal_place})
    ${calculated_value}    Convert To String    ${calculated_value}
    ${calculated_value}    Fix Decimal Places    ${calculated_value}
    Set Test Variable    ${commission_amount}    ${calculated_value}

Calculate Air Fees-HK Discount
    ${discount_formula}    Set Variable If    "${client_type_value.upper()}" == "DU" or "${client_type_value.upper()}" == "DB"    (${nett_fare_value}+${commission_amount})*(${discount_percentage_value}*0.01)    "${client_type_value.upper()}" == "MN" or "${client_type_value.upper()}" == "TF" or "${client_type_value.upper()}" == "TP"    ${discount_value}    0
    ${calculated_value}    Evaluate    ${discount_formula}
    Comment    ${rounded_value}    Run Keyword If    "${client_type_value.upper()}" == "DU" or "${client_type_value.upper()}" == "DB" or "${client_type_value.upper()}" == "MN" or "${client_type_value.upper()}" == "TF" or "${client_type_value.upper()}" == "TP"    Round Down    ${calculated_value}    ${decimal_place}
    ...    ELSE    Set Variable    ${calculated_value}
    ${calculated_value}    Evaluate    round(${calculated_value},${decimal_place})
    ${calculated_value}    Convert To String    ${calculated_value}
    ${calculated_value}    Fix Decimal Places    ${calculated_value}
    Set Test Variable    ${discount_amount}    ${calculated_value}

Calculate Air Fees-HK Merchant Fee
    ${uatp_not_exists}    Run Keyword And Return Status    Variable Should Not Exist    ${uatp_flag_value}
    Run Keyword If    "${uatp_not_exists}" == "True"    Set Test Variable    ${uatp_flag_value}    true
    Run Keyword If    "${uatp_flag_value}" == "true"    Calculate Air Fees-HK Merchant Fee With UATP
    ...    ELSE    Calculate Air Fees-HK Merchant Fee Without UATP

Calculate Air Fees-HK Merchant Fee With UATP
    ${merchant_fee_formula}    Set Variable If    "${country}" == "HK" and "${client_type_value.upper()}" == "TF"    ${transaction_fee_value}*(${merchant_fee_percentage_value}*0.01)    "${country}" == "HK" and "${client_type_value.upper()}" != "TF"    (${nett_fare_amount}-${nett_fare_original_value}-${tax_1_value}-${tax_2_value})*(${merchant_fee_percentage_value}*0.01)
    ${calculated_value}    Evaluate    ${merchant_fee_formula}
    Comment    ${calculated_value}    Round Up    ${calculated_value}    ${decimal_place}
    ${calculated_value}    Evaluate    round(${calculated_value},${decimal_place})
    Comment    ${calculated_value}    Evaluate    abs(${calculated_value})
    ${calculated_value}    Set Variable If    ${calculated_value} < 0    0    ${calculated_value} == -0    0    ${calculated_value}
    ${calculated_value}    Convert To String    ${calculated_value}
    ${calculated_value}    Fix Decimal Places    ${calculated_value}
    Set Test Variable    ${merchant_fee_amount}    ${calculated_value}

Calculate Air Fees-HK Merchant Fee Without UATP
    ${merchant_fee_formula}    Set Variable If    "${client_type_value.upper()}" == "TF" and "${tfincmf_flag_value}" == "true"    (${nett_fare_amount}+${transaction_fee_value})*(${merchant_fee_percentage_value}*0.01)    ${nett_fare_amount}*(${merchant_fee_percentage_value}*0.01)
    ${calculated_value}    Evaluate    ${merchant_fee_formula}
    Comment    ${calculated_value}    Round Up    ${calculated_value}    ${decimal_place}
    ${calculated_value}    Evaluate    round(${calculated_value},${decimal_place})
    ${calculated_value}    Convert To String    ${calculated_value}
    ${calculated_value}    Fix Decimal Places    ${calculated_value}
    Set Test Variable    ${merchant_fee_amount}    ${calculated_value}

Calculate Air Fees-HK Nett Cost In EO
    Comment    ${rounded_value}    Run Keyword If    "${web_fare_selected_flag}" == "true"    Round Up    ${nett_fare_value}    ${decimal_place}
    ...    ELSE    Set Variable    ${nett_fare_value}
    ${calculated_value}    Evaluate    round(${nett_fare_value},${decimal_place})
    ${calculated_value}    Convert To String    ${calculated_value}
    ${calculated_value}    Fix Decimal Places    ${calculated_value}
    Set Test Variable    ${nett_cost_amount}    ${calculated_value}

Calculate Air Fees-HK Nett Fare
    ${nett_fare_formula}    Set Variable If    "${client_type_value.upper()}" == "TF" or "${client_type_value.upper()}" == "MN"    ${selling_price_amount}+${tax_1_value}+${tax_2_value}    ${selling_price_amount}+${tax_1_value}+${tax_2_value}-${discount_amount}
    ${calculated_value}    Evaluate    ${nett_fare_formula}
    ${calculated_value}    Evaluate    round(${calculated_value},${decimal_place})
    ${calculated_value}    Convert To String    ${calculated_value}
    ${calculated_value}    Fix Decimal Places    ${calculated_value}
    Set Test Variable    ${nett_fare_original_value}    ${nett_fare_value}
    Set Test Variable    ${nett_fare_amount}    ${calculated_value}

Calculate Air Fees-HK Selling Price With Commission Amount
    Comment    ${selling_price_formula}    Set Variable If    "${web_fare_flag_value}" == "true"    ${nett_fare_value}+${commission_value}
    ${calculated_value}    Evaluate    ${nett_fare_value}+${commission_value}
    Comment    ${rounded_value}    Run Keyword If    "${web_fare_selected_flag}" == "true"    Round Up    ${calculated_value}    ${decimal_place}
    ...    ELSE    Set Variable    ${calculated_value}
    ${calculated_value}    Evaluate    round(${calculated_value},${decimal_place})
    ${calculated_value}    Convert To String    ${calculated_value}
    ${calculated_value}    Fix Decimal Places    ${calculated_value}
    Set Test Variable    ${selling_price_amount}    ${calculated_value}

Calculate Air Fees-HK Selling Price With Commission Percentage
    ${client_type_flag}    Set Variable If    "${client_type_value.upper()}" == "MG" or "${client_type_value.upper()}" == "DB" or "${client_type_value.upper()}" == "TF" or "${client_type_value.upper()}" == "MN"    true    false
    ${selling_price_formula}    Set Variable If    "${client_type_flag}" == "true" and "${web_fare_flag_value}" == "true"    ${nett_fare_value}/(1-(${commission_percentage_value}*0.01))    "${client_type_flag}" == "false" and "${web_fare_flag_value}" == "true"    ${nett_fare_value}/(1-(${commission_percentage_value}*0.01))+10    "${client_type_flag}" == "true" and "${web_fare_flag_value}" == "false"
    ...    ${nett_fare_value}/(1-(${commission_percentage_value}*0.01))    ${nett_fare_value}/(1-(${commission_percentage_value}*0.01))+10
    ${calculated_value}    Evaluate    ${selling_price_formula}
    Comment    ${rounded_value}    Run Keyword If    "${web_fare_selected_flag}" == "true"    Round Up    ${calculated_value}    ${decimal_place}
    ...    ELSE    Set Variable    ${calculated_value}
    ${calculated_value}    Evaluate    round(${calculated_value},${decimal_place})
    ${calculated_value}    Convert To String    ${calculated_value}
    ${calculated_value}    Fix Decimal Places    ${calculated_value}
    Set Test Variable    ${selling_price_amount}    ${calculated_value}

Calculate Air Fees-HK Total Selling Fare With Formula
    ${calculated_value}    Evaluate    ${nett_fare_amount}+${merchant_fee_amount}
    Comment    ${rounded_value}    Run Keyword If    "${web_fare_selected_flag}" == "true"    Round Up    ${calculated_value}    ${decimal_place}
    ...    ELSE    Set Variable    ${calculated_value}
    ${calculated_value}    Evaluate    round(${calculated_value},${decimal_place})
    ${calculated_value}    Convert To String    ${calculated_value}
    ${calculated_value}    Fix Decimal Places    ${calculated_value}
    Set Test Variable    ${total_selling_fare_amount}    ${calculated_value}

Calculate Air Fees-HK Total Selling Fare Without Formula
    ${calculated_value}    Evaluate    ${nett_fare_value}+${commission_value}-${discount_value}+${tax_1_value}+${tax_2_value}+${merchant_fee_value}
    Comment    ${rounded_value}    Run Keyword If    "${web_fare_selected_flag}" == "true"    Round Up    ${calculated_value}    ${decimal_place}
    ...    ELSE    Set Variable    ${calculated_value}
    ${calculated_value}    Evaluate    round(${calculated_value},${decimal_place})
    ${calculated_value}    Convert To String    ${calculated_value}
    ${calculated_value}    Fix Decimal Places    ${calculated_value}
    Set Test Variable    ${total_selling_fare_amount}    ${calculated_value}

Calculate Air Fees-SG Commission
    ${commission_formula}    Set Variable If    "${commission_percent_flag_value}" == "true"    ${nett_fare_value}*(${commission_percentage_value}*0.01)    ${commission_value}
    ${calculated_value}    Evaluate    ${commission_formula}
    ${calculated_value}    Evaluate    round(${calculated_value},${decimal_place})
    ${calculated_value}    Convert To String    ${calculated_value}
    ${calculated_value}    Fix Decimal Places    ${calculated_value}
    Set Test Variable    ${commission_amount}    ${calculated_value}

Calculate Air Fees-SG Discount
    ${client_type_flag}    Set Variable If    "${client_type_value.upper()}" == "DU" or "${client_type_value.upper()}" == "DB" or "${client_type_value.upper()}" == "TF" or "${client_type_value.upper()}" == "MN"    true    false
    ${discount_formula}    Set Variable If    "${client_type_flag}" == "true" and "${discount_percent_flag_value}" == "true"    ${nett_fare_value}*(${discount_percentage_value}*0.01)    "${client_type_flag}" == "true" and "${discount_percent_flag_value}" == "true"    0    ${discount_value}
    ${calculated_value}    Evaluate    ${discount_formula}
    ${calculated_value}    Evaluate    round(${calculated_value},${decimal_place})
    ${calculated_value}    Convert To String    ${calculated_value}
    ${calculated_value}    Fix Decimal Places    ${calculated_value}
    Set Test Variable    ${discount_amount}    ${calculated_value}

Calculate Air Fees-SG Merchant Fee
    Run Keyword If    "${product_type_value.upper()}" == "CT"    Calculate Air Fees-SG Merchant Fee For Product Type CT
    ...    ELSE    Calculate Air Fees-SG Merchant Fee For Non-Product Type CT

Calculate Air Fees-SG Merchant Fee For Non-Product Type CT
    ${merchant_fee_formula}    Set Variable If    "${client_type_value.upper()}" == "TF" and "${tfincmf_flag_value}" == "true"    (${selling_price_value}-${discount_amount}+${tax_1_value}+${tax_2_value}+${transaction_fee_value})*(${merchant_fee_percentage_value}*0.01)    (${selling_price_value}-${discount_amount}+${tax_1_value}+${tax_2_value})*(${merchant_fee_percentage_value}*0.01)
    ${calculated_value}    Evaluate    ${merchant_fee_formula}
    ${calculated_value}    Evaluate    round(${calculated_value},${decimal_place})
    ${calculated_value}    Convert To String    ${calculated_value}
    ${calculated_value}    Fix Decimal Places    ${calculated_value}
    Set Test Variable    ${merchant_fee_amount}    ${calculated_value}

Calculate Air Fees-SG Merchant Fee For Product Type CT
    ${merchant_fee_formula}    Set Variable If    "${client_type_value.upper()}" == "TF" and "${tfincmf_flag_value}" == "true"    (${nett_cost_amount}+${commission_amount}-${discount_amount}+${tax_1_value}+${tax_2_value}+${transaction_fee_value})*(${merchant_fee_percentage_value}*0.01)    (${nett_cost_amount}+${commission_amount}-${discount_amount}+${tax_1_value}+${tax_2_value})*(${merchant_fee_percentage_value}*0.01)
    ${calculated_value}    Evaluate    ${merchant_fee_formula}
    ${calculated_value}    Evaluate    round(${calculated_value},${decimal_place})
    ${calculated_value}    Convert To String    ${calculated_value}
    ${calculated_value}    Fix Decimal Places    ${calculated_value}
    Set Test Variable    ${merchant_fee_amount}    ${calculated_value}

Calculate Air Fees-SG Nett Cost In EO With Formula
    ${calculated_value}    Evaluate    ${nett_fare_value}-${commission_amount}
    ${calculated_value}    Evaluate    round(${calculated_value},${decimal_place})
    ${calculated_value}    Convert To String    ${calculated_value}
    ${calculated_value}    Fix Decimal Places    ${calculated_value}
    Set Test Variable    ${nett_cost_amount}    ${calculated_value}

Calculate Air Fees-SG Nett Cost In EO Without Formula
    ${calculated_value}    Evaluate    ${nett_fare_value}-${commission_value}
    ${calculated_value}    Evaluate    round(${calculated_value},${decimal_place})
    ${calculated_value}    Convert To String    ${calculated_value}
    ${calculated_value}    Fix Decimal Places    ${calculated_value}
    Set Test Variable    ${nett_cost_amount}    ${calculated_value}

Calculate Air Fees-SG Total Selling Fare With Formula
    ${total_selling_fare_formula}    Set Variable If    "${product_type_value.upper()}" == "CT"    ${nett_cost_amount}+${commission_amount}-${discount_amount}+${tax_1_value}+${tax_2_value}+${merchant_fee_amount}    ${selling_price_value}-${discount_amount}+${tax_1_value}+${tax_2_value}+${merchant_fee_amount}
    ${calculated_value}    Evaluate    ${total_selling_fare_formula}
    ${calculated_value}    Evaluate    round(${calculated_value},${decimal_place})
    ${calculated_value}    Convert To String    ${calculated_value}
    ${calculated_value}    Fix Decimal Places    ${calculated_value}
    Set Test Variable    ${total_selling_fare_amount}    ${calculated_value}

Calculate Air Fees-SG Total Selling Fare Without Formula
    ${total_selling_fare_formula}    Set Variable If    "${product_type_value.upper()}" == "CT"    ${nett_fare_value}-${discount_value}+${tax_1_value}+${tax_2_value}+${merchant_fee_value}    ${selling_price_value}-${discount_value}+${tax_1_value}+${tax_2_value}+${merchant_fee_value}
    ${calculated_value}    Evaluate    ${total_selling_fare_formula}
    ${calculated_value}    Evaluate    round(${calculated_value},${decimal_place})
    ${calculated_value}    Convert To String    ${calculated_value}
    ${calculated_value}    Fix Decimal Places    ${calculated_value}
    Set Test Variable    ${total_selling_fare_amount}    ${calculated_value}

Create Test Variables For Air Fees-HK
    [Arguments]    ${fees_list}    ${country}
    ${fees_list}    Split String    ${fees_list}    |
    : FOR    ${fees}    IN    @{fees_list}
    \    ${fees_item}    Split String    ${fees}    ,
    \    Set Test Variable    ${${fees_item[0]}_value}    ${fees_item[1]}
    Set Test Variable    ${fees_list}
    Set Test Variable    ${country}    ${country.upper()}
    Set Test Variable    ${service_fee_name}    air-fees

Generate Test Variables For Air Fees-HK
    [Arguments]    ${fees_list}    ${country}
    Create Test Variables For Air Fees-HK    ${fees_list}    ${country}
    ${decimal_place}    Set Variable If    "${country.upper()}" == "SG"    2    0
    Set Test Variable    ${decimal_place}
    Run Keyword If    "${apply_formula_value}" == "true"    Generate Test Variables For Air Fees-HK With Formula
    ...    ELSE    Generate Test Variables For Air Fees-HK Without Formula
    Run Keyword If    "${country.upper()}" != "SG"    Remove Decimal Places For Air Fees-HK

Generate Test Variables For Air Fees-HK With Formula
    Run Keyword If    "${commission_percent_flag_value}" == "true"    Run Keywords    Calculate Air Fees-HK Commission
    ...    AND    Calculate Air Fees-HK Selling Price With Commission Percentage
    ...    ELSE    Run Keywords    Calculate Air Fees-HK Selling Price With Commission Amount
    ...    AND    Set Test Variable    ${commission_amount}    ${commission_value}
    Run Keyword If    "${discount_percent_flag_value}" == "true"    Calculate Air Fees-HK Discount
    ...    ELSE    Set Test Variable    ${discount_amount}    ${discount_value}
    Run Keyword If    "${discount_value}" == "${EMPTY}" or"${client_type_value}" == "TF" or"${client_type_value}" == "MN"    Set Test Variable    ${discount_amount}    0
    Set Test Variable    ${nett_cost_amount}    ${nett_fare_value}
    Calculate Air Fees-HK Nett Fare
    Run Keyword If    "${cwt_absorb_value}" == "false" and "${cc_value.upper()}" == "CX" and "${merchant_fee_waive_value}" == "false"    Calculate Air Fees-HK Merchant Fee
    ...    ELSE    Set Test Variable    ${merchant_fee_amount}    0
    Calculate Air Fees-HK Total Selling Fare With Formula

Generate Test Variables For Air Fees-HK Without Formula
    Calculate Air Fees-HK Total Selling Fare Without Formula
    Calculate Air Fees-HK Nett Cost In EO
    Set Test Variable    ${commission_amount}    ${commission_value}
    Set Test Variable    ${merchant_fee_amount}    ${merchant_fee_value}
    Set Test Variable    ${selling_price_amount}    0
    Set Test Variable    ${discount_amount}    ${discount_value}
    Set Test Variable    ${nett_fare_amount}    ${nett_fare_value}

Generate Test Variables For Air Fees-SG
    [Arguments]    ${fees_list}    ${country}
    Create Test Variables For Air Fees-HK    ${fees_list}    ${country}
    ${decimal_place}    Set Variable If    "${country.upper()}" == "SG"    2    0
    Set Test Variable    ${decimal_place}
    Run Keyword If    "${apply_formula_value}" == "true"    Generate Test Variables For Air Fees-SG With Formula
    ...    ELSE    Generate Test Variables For Air Fees-SG Without Formula

Generate Test Variables For Air Fees-SG With Formula
    Calculate Air Fees-SG Commission
    Calculate Air Fees-SG Discount
    Calculate Air Fees-SG Nett Cost In EO With Formula
    ${tfincmf_not_exists}    Run Keyword And Return Status    Variable Should Not Exist    ${tfincmf_flag_value}
    Run Keyword If    "${tfincmf_not_exists}" == "True"    Set Test Variable    ${tfincmf_flag_value}    false
    Run Keyword If    "${cwt_absorb_value}" == "false" and "${cc_value.upper()}" == "CX" and "${merchant_fee_waive_value}" == "false"    Calculate Air Fees-SG Merchant Fee
    ...    ELSE    Set Test Variable    ${merchant_fee_amount}    0
    Calculate Air Fees-SG Total Selling Fare With Formula

Generate Test Variables For Air Fees-SG Without Formula
    Calculate Air Fees-SG Total Selling Fare Without Formula
    Calculate Air Fees-SG Nett Cost In EO Without Formula
    Set Test Variable    ${merchant_fee_amount}    ${merchant_fee_value}

Remove Decimal Places For Air Fees-HK
    ${commission_amount}    Remove String    ${commission_amount}    .00
    ${merchant_fee_amount}    Remove String    ${merchant_fee_amount}    .00
    ${total_selling_fare_amount}    Remove String    ${total_selling_fare_amount}    .00
    ${nett_cost_amount}    Remove String    ${nett_cost_amount}    .00
    ${selling_price_amount}    Remove String    ${selling_price_amount}    .00
    ${discount_amount}    Remove String    ${discount_amount}    .00
    ${nett_fare_amount}    Remove String    ${nett_fare_amount}    .00
    Set Test Variable    ${commission_amount}
    Set Test Variable    ${merchant_fee_amount}
    Set Test Variable    ${total_selling_fare_amount}
    Set Test Variable    ${nett_cost_amount}
    Set Test Variable    ${selling_price_amount}
    Set Test Variable    ${discount_amount}
    Set Test Variable    ${nett_fare_amount}

Verify Calculated Air Fees Are Returned Correctly
    ${data}    Remove String    ${response.text}    {
    ${data}    Remove String    ${data}    }
    ${data}    Remove String    ${data}    "
    ${data_list}    Split String    ${data}    ,
    : FOR    ${item}    IN    @{data_list}
    \    ${items}    Split String    ${item}    :
    \    Verify Actual Numerical Value Matches Expected Numerical Value    ${items[1]}    ${${items[0]}_amount}

Verify Response Does Not Contain Calculated Fee
    [Arguments]    ${element}
    Verify String Does Not Contain Substring    ${response.content}    "${element}"
