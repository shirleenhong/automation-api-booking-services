*** Keywords ***
Append Additional Fields For BSP
    [Arguments]    ${other_service_fees_request_list}
    Run Keyword If    "${nett_fare_value}"!="null"    Append To List    ${other_service_fees_request_list}    "nettFareAmount":${nett_fare_value}
    Run Keyword If    "${gross_fare_value}"!="null"    Append To List    ${other_service_fees_request_list}    "grossFareAmount":${gross_fare_value}
    Run Keyword If    "${tax1_value}"!="null"    Append To List    ${other_service_fees_request_list}    "tax1Amount":${tax1_value}
    Run Keyword If    "${tax1_code_value}"!="null"    Append To List    ${other_service_fees_request_list}    "tax1Code":"${tax1_code_value}"
    Run Keyword If    "${tax2_value}"!="null"    Append To List    ${other_service_fees_request_list}    "tax2Amount":${tax2_value}
    Run Keyword If    "${tax2_code_value}"!="null"    Append To List    ${other_service_fees_request_list}    "tax2Code":"${tax2_code_value}"
    Run Keyword If    "${commission_percentage_value}"!="null"    Append To List    ${other_service_fees_request_list}    "commissionRebatePercentage":${commission_percentage_value}
    Run Keyword If    "${discount_percentage_value}"!="null"    Append To List    ${other_service_fees_request_list}    "discountPercentage":${discount_percentage_value}
    Run Keyword If    "${apply_formula_value}"!="null"    Append To List    ${other_service_fees_request_list}    "applyFormula":${apply_formula_value}
    Run Keyword If    "${uatp_flag_value}"!="null"    Append To List    ${other_service_fees_request_list}    "uatpFlag":${uatp_flag_value}
    Run Keyword If    "${waive_merchant_value}"!="null"    Append To List    ${other_service_fees_request_list}    "waiveMerchant":${waive_merchant_value}
    [Return]    ${other_service_fees_request_list}

Append Additional Fields For Miscellaneous Fees
    [Arguments]    ${other_service_fees_request_list}
    Run Keyword If    "${selling_price_value}"!="null"    Append To List    ${other_service_fees_request_list}    "sellingPrice":${selling_price_value}
    Run Keyword If    "${nett_cost_value}"!="null"    Append To List    ${other_service_fees_request_list}    "nettCost":${nett_cost_value}
    Run Keyword If    "${gst_percent_value}"!="null"    Append To List    ${other_service_fees_request_list}    "gstPercent":${gst_percent_value}
    Run Keyword If    "${gst_absorb_value}"!="null"    Append To List    ${other_service_fees_request_list}    "gstAbsorb":${gst_absorb_value}
    [Return]    ${other_service_fees_request_list}

Calculate Other Service Fees Commission
    ${calculated_value}    Evaluate    ${selling_price_in_di}-${nett_cost_value}
    ${calculated_value}    Evaluate    round(${calculated_value},${decimal_place})
    Set Test Variable    ${commission}    ${calculated_value}

Calculate Other Service Fees GST
    ${calculated_value}    Evaluate    ${selling_price_value}*(${gst_percent_value}*0.01)
    ${calculated_value}    Evaluate    round(${calculated_value},${decimal_place})
    Set Test Variable    ${gst}    ${calculated_value}

Calculate Other Service Fees Mechant Fee
    ${calculated_value}    Evaluate    ${selling_price_value}*(1+${gst_percent_value}*0.01)*(${merchant_fee_percent_value}*0.01)
    ${calculated_value}    Evaluate    round(${calculated_value},${decimal_place})
    Set Test Variable    ${merchant_fee}    ${calculated_value}

Calculate Other Service Fees Nett Cost GST
    ${calculated_value}    Evaluate    ${nett_cost_value}*(${gst_percent_value}*0.01)
    ${calculated_value}    Evaluate    round(${calculated_value},${decimal_place})
    Set Test Variable    ${nett_cost_gst}    ${calculated_value}

Calculate Other Service Fees Selling Price In DI
    ${calculated_value}    Evaluate    (${selling_price_value}+${gst}+${merchant_fee})/(1+${gst_percent_value}*0.01)
    ${calculated_value}    Evaluate    round(${calculated_value},${decimal_place})
    Set Test Variable    ${selling_price_in_di}    ${calculated_value}

Create Test Variables For Other Service Fee
    [Arguments]    ${fees_list}    ${country}=sg    ${service_fee_name}=misc-fees
    [Documentation]    service fee names:
    ...    misc-fees
    ...    car
    ...    bsp
    ...    bsp-air
    ...
    ...    fees_list fields:
    ...    cc,(cc, cx or inv)|client_type,aa|pro_name,aaa|merchant_absorb,boolean|merchant_waive,boolean
    ...
    ...    additional fields for misc-fees ad car
    ...    selling_price,nn.nn|nett_cost,nn.nn|gst_percentage,nn.nn|gst_absorb,boolean
    ...
    ...    additional fields for bsp/bsp-air:
    ...    nett_fare,nn.nn|gross_fare,nn.nn|tax1,nn.nn|tax1_code,aa|tax2,nn.nn|tax2_code,aa|commission_percentage,nn.nn|discount_percentage,nn.nn|apply_formula,boolean|uatp_flag,boolean|waive_merchant,boolean
    ${fees_list}    Split String    ${fees_list}    |
    : FOR    ${fees}    IN    @{fees_list}
    \    ${fees_item}    Split String    ${fees}    ,
    \    Set Test Variable    ${${fees_item[0]}_value}    ${fees_item[1]}
    Set Test Variable    ${fees_list}
    Set Test Variable    ${country}    ${country.upper()}
    Set Test Variable    ${service_fee_name}

Generate Test Variables For Other Service Fees
    [Arguments]    ${fees_list}    ${country}=sg    ${service_fee_name}=misc-fees
    Create Test Variables For Other Service Fee    ${fees_list}    ${country}    ${service_fee_name}
    ${decimal_place}    Set Variable If    "${country.upper()}" == "SG"    2    0
    Set Test Variable    ${decimal_place}
    Run Keyword If    "${gst_absorb_value}" == "false"    Run Keywords    Calculate Other Service Fees GST
    ...    AND    Calculate Other Service Fees Nett Cost GST
    ...    ELSE    Run Keywords    Set Test Variable    ${gst}    0
    ...    AND    Set Test Variable    ${nett_cost_gst}    0
    Run Keyword If    "${merchant_absorb_value}" == "false" and "${cc_value.upper()}" == "CX" and "${merchant_waive_value}" == "false"    Calculate Other Service Fees Mechant Fee
    ...    ELSE    Set Test Variable    ${merchant_fee}    0
    Calculate Other Service Fees Selling Price In DI
    Run Keyword If    ${selling_price_in_di}>${nett_cost_value}    Calculate Other Service Fees Commission
    ...    ELSE    Set Test Variable    ${commission}    0
    Run Keyword If    "${country.upper()}" != "SG"    Remove Decimal Places

Get Rounding Rules
    Send Currency Get Request
    ${decimal_value}    Get Json Value    ${response.content}    /decimal
    ${round_rule_value}    Get Json Value    ${response.content}    /roundRule
    Set Test Variable    ${decimal_place}    ${decimal_value}
    Set Test Variable    ${rounding_rule}    ${round_rule_value}

Remove Decimal Places
    ${selling_price_in_di}    Convert To String    ${selling_price_in_di}
    ${gst}    Convert To String    ${gst}
    ${merchant_fee}    Convert To String    ${merchant_fee}
    ${commission}    Convert To String    ${commission}
    ${nett_cost_gst}    Convert To String    ${nett_cost_gst}
    ${selling_price_in_di}    Remove String    ${selling_price_in_di}    .0
    ${gst}    Remove String    ${gst}    .0
    ${merchant_fee}    Remove String    ${merchant_fee}    .0
    ${commission}    Remove String    ${commission}    .0
    ${nett_cost_gst}    Remove String    ${nett_cost_gst}    .0
    Set Test Variable    ${selling_price_in_di}
    Set Test Variable    ${gst}
    Set Test Variable    ${merchant_fee}
    Set Test Variable    ${commission}
    Set Test Variable    ${nett_cost_gst}

Send Currency Get Request
    [Arguments]    ${token}=${default_token}    ${currency_code}=${currency_code_value}
    Create Session    fees    ${${env}_base_url}    verify=True
    ${headers}    Run Keyword If    "${token}" != "None"    Create Dictionary    Content-Type=application/json    Authorization=Bearer ${token}
    ...    ELSE    Create Dictionary    Content-Type=application/json
    ${response}    Get Request    fees    apac-services-rest/api/merchant/currency/${currency_code}    headers=${headers}
    Set Test Variable    ${response}
    Log    ${response.headers}
    Log    ${response.content}
    Set Test Variable    ${api_flag}    fees

Send Other Service Fees Post Request
    [Arguments]    ${token}=${default_token}
    Create Session    fees    ${${env}_base_url}    verify=True
    ${headers}    Run Keyword If    "${token}" != "None"    Create Dictionary    Content-Type=application/json    Authorization=Bearer ${token}
    ...    ELSE    Create Dictionary    Content-Type=application/json
    ${other_service_fees_request_list}    Create List
    Run Keyword If    "${country}"!="null"    Append To List    ${other_service_fees_request_list}    "countryCode":"${country}"
    Run Keyword If    "${cc_value}"!="null"    Append To List    ${other_service_fees_request_list}    "fopType":"${cc_value}"
    Run Keyword If    "${merchant_absorb_value}"!="null"    Append To List    ${other_service_fees_request_list}    "merchantFeeAbsorb":${merchant_absorb_value}
    Run Keyword If    "${merchant_waive_value}"!="null"    Append To List    ${other_service_fees_request_list}    "merchantFeeWaive":${merchant_waive_value}
    Run Keyword If    "${client_type_value}"!="null"    Append To List    ${other_service_fees_request_list}    "clientType":"${client_type_value}"
    Run Keyword If    "${pro_name_value}"!="null"    Append To List    ${other_service_fees_request_list}    "productName":"${pro_name_value}"
    Set Test Variable    ${other_service_fees_request_list}
    ${other_service_fees_request_list}    Run Keyword If    "${service_fee_name}"=="misc-fees" or "${service_fee_name}"=="car"    Append Additional Fields For Miscellaneous Fees    ${other_service_fees_request_list}
    ...    ELSE IF    "${service_fee_name}"=="bsp-air" or "${service_fee_name}"=="bsp"    Append Additional Fields For BSP    ${other_service_fees_request_list}
    ${list_count}    Get Length    ${other_service_fees_request_list}
    : FOR    ${i}    IN RANGE    0    ${list_count}
    \    ${fees_list}    Set Variable If    ${i}==0    ${EMPTY}    ${fees_list},
    \    ${fees_list}    Set Variable    ${fees_list}${other_service_fees_request_list[${i}]}
    ${data}    Set Variable    {${fees_list}}
    Log    ${data}
    ${response}    Post Request    fees    /apac-services-rest/api/other-service-fees/${service_fee_name}    data=${data}    headers=${headers}
    Set Test Variable    ${response}
    Log    ${response.headers}
    Log    ${response.content}
    Set Test Variable    ${api_flag}    fees

Verify Calculated Miscellaneous Fees Are Returned Correctly
    Verify Json Value Is Correct    /sellingPriceInDi    ${selling_price_in_di}    int
    Verify Json Value Is Correct    /commission    ${commission}    int
    Run Keyword If    "${gst_absorb_value}"=="false"    Verify Json Value Is Correct    /gstAmount    ${gst}    int
    ...    ELSE    Verify Json Element Does Not Exist    /gstAmount
    Run Keyword If    "${merchant_absorb_value}"=="false"    Verify Json Value Is Correct    /merchantFee    ${merchant_fee}    int
    ...    ELSE    Verify Json Element Does Not Exist    /merchantFee
    Run Keyword If    "${gst_absorb_value}"=="false" and "${nett_cost_value}"!="0"    Verify Json Value Is Correct    /nettCostGst    ${nett_cost_gst}    int
    ...    ELSE    Verify Json Element Does Not Exist    /nettCostGst

Verify Calculated Other Service Fees BSP Air Are Returned Correctly

Verify Calculated Other Service Fees Are Not Returned
    Verify String Does Not Contain Substring    ${response.content}    "sellingPriceInDi"
    Verify String Does Not Contain Substring    ${response.content}    "merchantFeeAmount"
    Verify String Does Not Contain Substring    ${response.content}    "gstAmount"
    Verify String Does Not Contain Substring    ${response.content}    "nettCostGst"
    Verify String Does Not Contain Substring    ${response.content}    "commission"
