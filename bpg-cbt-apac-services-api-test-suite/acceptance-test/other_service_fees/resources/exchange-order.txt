*** Setting ***
Resource    ../../resources/api-imports.txt
Resource    ../../resources/api-utilities.txt
Resource    ../../resources/api-variables.txt

***Keywords***
Create Test Variables For Exchange Order
    [Arguments]    ${eo_data}    ${remarks_data}    
    ${eo_data_list}    Split String    ${eo_data}    |
    ${eo_data_list_length}    Get Length    ${eo_data_list}
    Set Test Variable    ${eo_data_list_length}
    Set Test Variable    ${eo_data_list}
    : FOR    ${data}    IN    @{eo_data_list}
    \    ${data_item}    Split String    ${data}    ,
    \    Set Test Variable    ${${data_item[0]}_value}    ${data_item[1]}
    ${remarks_data_list}    Split String    ${remarks_data}    |
    ${remarks_data_list_length}    Get Length    ${remarks_data_list}
    Set Test Variable    ${remarks_data_list_length}
    Set Test Variable    ${remarks_data_list}
    : FOR    ${index}    IN RANGE    0    ${remarks_data_list_length}
    \    ${data_item}    Split String    ${remarks_data_list[${index}]}    ,
    \    Set Test Variable    ${product_type_value_${index}}    ${data_item[0]}
    \    Set Test Variable    ${remark_type_value_${index}}    ${data_item[1]}
    \    Set Test Variable    ${text_value_${index}}    ${data_item[2]}
    ${current_date_time}    Get Current Date    time_zone=utc
    ${current_year}    Get Substring    ${current_date_time}     2    4
    ${current_month}    Get Substring    ${current_date_time}    5    7
    ${market}    Set Variable If    "${country_value}"=="HK"    1    "${country_value}"=="SG"    2    3
    Set Test Variable    ${current_date_time}
    Set Test Variable    ${current_year}
    Set Test Variable    ${current_month}
    Set Test Variable    ${market} 
    
Send Other Service Fees For Exchange Order Get Request 
    [Arguments]    ${exchange_order_number}=${exchange_order_number}    ${token}=${default_token}
    Create Session    exchange-order    ${${env}_base_url}    verify=True
    ${headers}    Run Keyword If    "${token}" != "None"    Create Dictionary    Content-Type=application/json    Authorization=Bearer ${token}
    ...    ELSE    Create Dictionary    Content-Type=application/json
    ${response}    Get Request    exchange-order    /apac-services-rest/api/other-service-fees/exchange-order/${exchange_order_number}    headers=${headers}
    Set Test Variable    ${response}
    Log    ${response.headers}
    Log    ${response.content}
    Set Test Variable    ${api_flag}    exchange-order

Send Other Service Fees For Exchange Order Post Request 
    [Arguments]    ${token}=${default_token}
    Create Session    exchange-order    ${${env}_base_url}    verify=True
    ${headers}    Run Keyword If    "${token}" != "None"    Create Dictionary    Content-Type=application/json    Authorization=Bearer ${token}
    ...    ELSE    Create Dictionary    Content-Type=application/json
    ${exchange_order_request_list}    Create List
    ${exchange_order_cc_request_list}    Create List
    ${exchange_order_rmk_request_list}    Create List
    Run Keyword If    "${country_value}"!="null"    Append To List    ${exchange_order_request_list}    "countryCode":"${country_value}"
    Run Keyword If    "${commission_value}"!="null"    Append To List    ${exchange_order_request_list}    "commission":${commission_value}
    Run Keyword If    "${gst_amount_value}"!="null"    Append To List    ${exchange_order_request_list}    "gstAmount":${gst_amount_value}
    Run Keyword If    "${merchant_fee_value}"!="null"    Append To List    ${exchange_order_request_list}    "merchantFee":${merchant_fee_value}
    Run Keyword If    "${fop_type_value}"!="null"    Append To List    ${exchange_order_request_list}    "fopType":"${fop_type_value}"
    Run Keyword If    "${description_value}"!="null"    Append To List    ${exchange_order_request_list}    "description":"${description_value}"
    Run Keyword If    "${bta_description_value}"!="null"    Append To List    ${exchange_order_request_list}    "btaDescription":"${bta_description_value}"
    Run Keyword If    "${date_value}"!="null"    Append To List    ${exchange_order_request_list}    "additionalInfoDate":"${date_value}"
    Run Keyword If    "${vendor_contact_value}"!="null"    Append To List    ${exchange_order_request_list}    "vendorContactPerson":"${vendor_contact_value}"
    Run Keyword If    "${product_code_value}"!="null"    Append To List    ${exchange_order_request_list}    "productCode":"${product_code_value}"
    Run Keyword If    "${vendor_code_value}"!="null"    Append To List    ${exchange_order_request_list}    "vendorCode":"${vendor_code_value}"
    Run Keyword If    "${pnr_value}"!="null"    Append To List    ${exchange_order_request_list}    "pnr":"${pnr_value}"
    Run Keyword If    "${account_number_value}"!="null"    Append To List    ${exchange_order_request_list}    "accountNumber":"${account_number_value}"
    Run Keyword If    "${passenger_name_value}"!="null"    Append To List    ${exchange_order_request_list}    "passengerName":"${passenger_name_value}"
    Run Keyword If    "${agent_id_value}"!="null"    Append To List    ${exchange_order_request_list}    "agentId":"${agent_id_value}"
    Run Keyword If    "${pcc_value}"!="null"    Append To List    ${exchange_order_request_list}    "pcc":"${pcc_value}"
    Run Keyword If    "${vendor_email_value}"!="null"    Append To List    ${exchange_order_request_list}    "vendorEmail":"${vendor_email_value}"
    Run Keyword If    "${vendor_fax_value}"!="null"    Append To List    ${exchange_order_request_list}    "faxNumber":"${vendor_fax_value}" 
    Run Keyword If    "${cc_type_value}"!="null"    Append To List    ${exchange_order_cc_request_list}    "ccType":"${cc_type_value}"
    Run Keyword If    "${cc_number_value}"!="null"    Append To List    ${exchange_order_cc_request_list}    "ccNumber":"${cc_number_value}"
    Run Keyword If    "${expiry_date_value}"!="null"    Append To List    ${exchange_order_cc_request_list}    "expiryDate":"${expiry_date_value}"
    : FOR    ${index}    IN RANGE    0    ${remarks_data_list_length}
    \    ${country}    Set Variable If    "${country_value}"!="null"    "countryCode":"${country_value}"    ${EMPTY}
    \    ${product}    Set Variable If    "${product_type_value_${index}}"!="null"    "productType":"${product_type_value_${index}}"    ${EMPTY}        
    \    ${type}    Set Variable If    "${remark_type_value_${index}}"!="null"    "remarkType":"${remark_type_value_${index}}"    ${EMPTY}
    \    ${text}    Set Variable If    "${text_value_${index}}"!="null"    "text":"${text_value_${index}}"    ${EMPTY}
    \    ${remarks_parameter_list}    Set Variable    {${country},${product},${type},${text}}
    \    ${remarks_parameter_list}    Replace String    ${remarks_parameter_list}    ,,    ,
    \    ${remarks_parameter_list}    Replace String    ${remarks_parameter_list}    {,    {
    \    ${remarks_parameter_list}    Replace String    ${remarks_parameter_list}    ,}    }
    \    Append To List    ${exchange_order_rmk_request_list}    ${remarks_parameter_list}
    ${rmk_list_length}    Get Length    ${exchange_order_rmk_request_list}
    : FOR    ${i}    IN RANGE    0    ${rmk_list_length}
    \    ${rmk_list}    Set Variable If    ${i}==0    ${EMPTY}    ${rmk_list},
    \    ${rmk_list}    Set Variable    ${rmk_list}${exchange_order_rmk_request_list[${i}]}
    ${list_count}    Get Length    ${exchange_order_request_list}
    : FOR    ${i}    IN RANGE    0    ${list_count}
    \    ${eo_list}    Set Variable If    ${i}==0    ${EMPTY}    ${eo_list},
    \    ${eo_list}    Set Variable    ${eo_list}${exchange_order_request_list[${i}]}
    ${cc_list_count}    Get Length    ${exchange_order_cc_request_list}
    : FOR    ${i}    IN RANGE    0    ${cc_list_count}
    \    ${cc_list}    Set Variable If    ${i}==0    ${EMPTY}    ${cc_list},
    \    ${cc_list}    Set Variable    ${cc_list}${exchange_order_cc_request_list[${i}]}    
    ${data}    Set Variable    {${eo_list},"creditCard":{${cc_list}},"remarks":[${rmk_list}]}
    ${data}    Replace String    ${data}    "NULL"    null
    ${data}    Replace String    ${data}    "None"    None
    Log    ${data}
    ${response}    Post Request    exchange-order    /apac-services-rest/api/other-service-fees/exchange-order    data=${data}    headers=${headers}
    Set Test Variable    ${response}
    Log    ${response.headers}
    Log    ${response.content}
    Set Test Variable    ${api_flag}    exchange-order

Verify Exchange Order Number Is Returned Correctly
    ${exchange_order_number}    Get Json Value As String    ${response.content}    $.eoNumber
    Set Test Variable    ${exchange_order_number}   
    ${eo_year}    Get Substring    ${exchange_order_number}    0    2
    ${eo_month}    Get Substring    ${exchange_order_number}    2    4
    ${eo_market}    Get Substring    ${exchange_order_number}    4    5   
    ${eo_sequence}    Get Substring    ${exchange_order_number}    5    10
    Verify Actual Value Matches Expected Value   ${eo_year}    ${current_year}
    Verify Actual Value Matches Expected Value   ${eo_month}    ${current_month}
    Verify Actual Value Matches Expected Value   ${eo_market}    ${market}
    Verify String Matches Pattern    ${eo_sequence}    ^[0-9_]*$
    
Verify Exchange Order Is Saved Correctly
    Verify Json Value Is Correct    $.countryCode    ${country_value} 
    Verify Json Value Is Correct    $.commission    ${commission_value} 
    Verify Json Value Is Correct    $.gstAmount    ${gst_amount_value} 
    Verify Json Value Is Correct    $.merchantFee    ${merchant_fee_value} 
    Verify Json Value Is Correct    $.fopType    ${fop_type_value} 
    Verify Json Value Is Correct    $.creditCard.ccType    ${cc_type_value} 
    Verify Json Value Is Correct    $.creditCard.ccNumber    ${cc_number_value} 
    Verify Json Value Is Correct    $.creditCard.expiryDate    ${expiry_date_value} 
    Verify Json Value Is Correct    $.description    ${description_value} 
    Verify Json Value Is Correct    $.btaDescription    ${bta_description_value} 
    Verify Json Value Is Correct    $.additionalInfoDate    ${date_value} 
    Verify Json Value Is Correct    $.vendorContactPerson    ${vendor_contact_value} 
    Verify Json Value Is Correct    $.productCode    ${product_code_value} 
    Verify Json Value Is Correct    $.vendorCode    ${vendor_code_value} 
    Verify Json Value Is Correct    $.pnr    ${pnr_value}
    Verify Json Value Is Correct    $.accountNumber    ${account_number_value} 
    Verify Json Value Is Correct    $.passengerName    ${passenger_name_value} 
    Verify Json Value Is Correct    $.agentId    ${agent_id_value} 
    Verify Json Value Is Correct    $.pcc    ${pcc_value} 
    Verify Json Value Is Correct    $.vendorEmail    ${vendor_email_value} 
    Verify Json Value Is Correct    $.faxNumber    ${vendor_fax_value} 
    Verify Json Value Is Correct    $.eoNumber    ${exchange_order_number}
    ${expected_date_time}    Get Substring    ${current_date_time}    0    18
    ${expected_date_time}    Replace String    ${expected_date_time}    ${SPACE}    T
    ${actual_date_time}    Get Json Value As String    ${response.content}    $.createDateTime
    ${actual_date_time}    Get Substring    ${actual_date_time}    0    18
    Verify Actual Value Matches Expected Value    ${actual_date_time}    ${expected_date_time}
    Verify Json Value Matches Pattern    $.createDateTime    ^[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]T[0-9][0-9]:[0-9][0-9]:[0-9][0-9].[0-9][0-9][0-9]Z+$
    : FOR    ${index}    IN RANGE    0    ${remarks_data_list_length}
    \    Verify Json Value Is Correct    $.remarks.[${index}].countryCode    ${country_value}
    \    Verify Json Value Is Correct    $.remarks.[${index}].productType    ${product_type_value_${index}}
    \    Verify Json Value Is Correct    $.remarks.[${index}].remarkType    ${remark_type_value_${index}}
    \    Verify Json Value Is Correct    $.remarks.[${index}].text    ${text_value_${index}}
  
Verify Exchange Order Is Not Returned
    Verify String Does Not Contain Substring    ${response.content}    "countryCode"
    Verify String Does Not Contain Substring    ${response.content}    "commission"
    Verify String Does Not Contain Substring    ${response.content}    "gstAmount"
    Verify String Does Not Contain Substring    ${response.content}    "merchantFee"
    Verify String Does Not Contain Substring    ${response.content}    "fopType"
    Verify String Does Not Contain Substring    ${response.content}    "creditCard"
    Verify String Does Not Contain Substring    ${response.content}    "description"
    Verify String Does Not Contain Substring    ${response.content}    "btaDescription"
    Verify String Does Not Contain Substring    ${response.content}    "additionalInfoDate"
    Verify String Does Not Contain Substring    ${response.content}    "vendorContactPerson"
    Verify String Does Not Contain Substring    ${response.content}    "productCode"
    Verify String Does Not Contain Substring    ${response.content}    "vendorCode"
    Verify String Does Not Contain Substring    ${response.content}    "pnr"
    Verify String Does Not Contain Substring    ${response.content}    "accountNumber"
    Verify String Does Not Contain Substring    ${response.content}    "passengerName"
    Verify String Does Not Contain Substring    ${response.content}    "agentId"
    Verify String Does Not Contain Substring    ${response.content}    "pcc"
    Verify String Does Not Contain Substring    ${response.content}    "vendorEmail"
    Verify String Does Not Contain Substring    ${response.content}    "faxNumber"
    Verify String Does Not Contain Substring    ${response.content}    "remarks"
    Verify String Does Not Contain Substring    ${response.content}    "eoNumber"
    Verify String Does Not Contain Substring    ${response.content}    "createDateTime"
    